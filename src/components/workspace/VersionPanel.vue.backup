<template>
  <div class="h-full bg-white flex flex-col">
    <!-- ç‰ˆæœ¬é¢æ¿å¤´éƒ¨ -->
    <div class="flex items-center justify-between px-4 py-3 border-b bg-gray-50">
      <div class="flex items-center gap-2">
        <h3 class="text-lg font-semibold text-gray-900">ç‰ˆæœ¬å†å²</h3>
        <span class="text-xs px-2 py-1 bg-blue-100 text-blue-600 rounded-full">
          {{ commits.length }} ä¸ªç‰ˆæœ¬
        </span>
      </div>
      <div class="flex items-center gap-2">
        <button
          @click="createCommit"
          class="px-3 py-1 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
        >
          ğŸ“ æäº¤
        </button>
        <button
          @click="diffSelected"
          :disabled="selectedIds.length !== 2"
          class="px-3 py-1 text-xs bg-green-500 text-white rounded-md hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
        >
          ğŸ”„ å¯¹æ¯”
        </button>
        <button
          @click="$emit('close')"
          class="p-1 text-gray-400 hover:text-gray-600 rounded"
        >
          âœ•
        </button>
      </div>
    </div>

    <!-- ç‰ˆæœ¬åˆ—è¡¨ -->
    <div class="flex-1 overflow-auto">
      <div v-if="commits.length === 0" class="p-6 text-center text-gray-500">
        <div class="text-3xl mb-3">ğŸ“</div>
        <p class="text-sm mb-2">è¿˜æ²¡æœ‰ç‰ˆæœ¬è®°å½•</p>
        <p class="text-xs text-gray-400">ç¼–è¾‘æ–‡æ¡£æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬</p>
      </div>

      <div v-else class="p-3">
        <div
          v-for="(commit, index) in commits"
          :key="commit.id"
          :class="[
            'mb-3 p-3 rounded-lg border-l-4 transition-all duration-200',
            index === 0 ? 'border-l-blue-500 bg-blue-50' : 'border-l-gray-300 bg-white hover:bg-gray-50',
            'shadow-sm hover:shadow-md'
          ]"
        >
          <!-- ç‰ˆæœ¬å¤´éƒ¨ -->
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
              <input
                type="checkbox"
                :value="commit.id"
                v-model="selectedIds"
                class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
              />
              <div class="flex items-center gap-2">
                <span :class="[
                  'text-xs px-2 py-1 rounded-full',
                  index === 0 ? 'bg-blue-100 text-blue-700 border border-blue-200' : 'bg-gray-100 text-gray-600'
                ]">
                  {{ index === 0 ? 'å½“å‰' : `v${commits.length - index}` }}
                </span>
                <span
                  v-if="commit.isAutoCommit"
                  class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-600 border border-green-200"
                >
                  è‡ªåŠ¨
                </span>
              </div>
            </div>
            <span class="text-xs text-gray-400">
              {{ formatTimeAgo(commit.timestamp) }}
            </span>
          </div>

          <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
          <div class="mb-2">
            <p class="text-sm font-medium text-gray-900 mb-1">
              {{ commit.message || 'æ— æ ‡é¢˜æäº¤' }}
            </p>
            <p class="text-xs text-gray-500">
              {{ formatDateTime(commit.timestamp) }} â€¢ ID: {{ commit.id.slice(-8) }}
            </p>
          </div>

          <!-- ç‰ˆæœ¬æ“ä½œ -->
          <div class="flex justify-between items-center">
            <div class="text-xs text-gray-500">
              {{ getVersionWordCount(commit.id) }} å­—
            </div>
            <div class="flex items-center gap-1">
              <button
                @click="handleViewVersion(commit)"
                class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors"
              >
                æŸ¥çœ‹
              </button>
              <button
                v-if="index !== 0"
                @click="handleRevertToVersion(commit)"
                class="px-2 py-1 text-xs bg-orange-100 text-orange-600 rounded hover:bg-orange-200 transition-colors"
              >
                å›æ»š
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¯¹æ¯”ç»“æœæ˜¾ç¤ºåŒºåŸŸï¼ˆåŒè‰² Diffï¼‰ -->
    <div v-if="diffChanges.length" class="border-t bg-gray-50 p-3 max-h-56 overflow-auto">
      <div class="flex justify-between items-center mb-2">
        <div class="flex items-center gap-3">
          <h4 class="text-sm font-medium text-gray-900">ç‰ˆæœ¬å¯¹æ¯”ç»“æœ</h4>
          <div class="text-xs text-gray-500">
            <span class="px-2 py-0.5 rounded bg-green-100 text-green-700 border border-green-200 mr-1">+{{ diffStats.added }}</span>
            <span class="px-2 py-0.5 rounded bg-red-100 text-red-700 border border-red-200">-{{ diffStats.removed }}</span>
          </div>
        </div>
        <button
          @click="clearDiff"
          class="text-xs text-gray-500 hover:text-gray-700"
        >
          å…³é—­
        </button>
      </div>
      <div class="bg-white border rounded overflow-hidden">
        <div v-for="(c, idx) in diffChanges" :key="idx"
             :class="[
               'text-xs font-mono px-2 py-1 border-b last:border-b-0',
               c.type === 'added' ? 'bg-green-50 text-green-800 border-green-100' :
               c.type === 'removed' ? 'bg-red-50 text-red-800 border-red-100' :
               'text-gray-700'
             ]">
          <span v-if="c.type==='added'" class="mr-2 text-green-600">+ </span>
          <span v-else-if="c.type==='removed'" class="mr-2 text-red-600">- </span>
          <span v-else class="mr-2 text-gray-400">Â· </span>
          <span class="whitespace-pre-wrap">{{ c.value }}</span>
        </div>
      </div>
    </div>

    <!-- ç‰ˆæœ¬æ“ä½œé¢æ¿ -->
    <div class="border-t bg-gray-50 p-3">
      <div class="text-xs text-gray-500 mb-2">å¿«é€Ÿæ“ä½œ</div>
      <div class="flex gap-2">
        <button
          @click="handleAutoSave"
          :disabled="!hasUnsavedChanges"
          :class="[
            'flex-1 px-3 py-2 text-xs rounded-md transition-colors',
            hasUnsavedChanges
              ? 'bg-green-500 text-white hover:bg-green-600'
              : 'bg-gray-200 text-gray-400 cursor-not-allowed'
          ]"
        >
          ä¿å­˜å½“å‰ç‰ˆæœ¬
        </button>
        <button
          @click="clearSelected"
          :disabled="selectedIds.length === 0"
          class="px-3 py-2 text-xs bg-gray-200 text-gray-600 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          æ¸…é™¤é€‰æ‹©
        </button>
      </div>
    </div>
  </div>

  <!-- ç‰ˆæœ¬è¯¦æƒ…å¼¹çª— -->
  <div
    v-if="showVersionDetail"
    class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    @click="closeVersionDetail"
  >
    <div
      class="bg-white rounded-lg shadow-2xl w-[80vw] h-[80vh] flex flex-col"
      @click.stop
    >
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <div>
          <h3 class="text-lg font-semibold">ç‰ˆæœ¬è¯¦æƒ…</h3>
          <p class="text-sm text-gray-500" v-if="selectedCommit">
            {{ selectedCommit.message }} - {{ formatDateTime(selectedCommit.timestamp) }}
          </p>
        </div>
        <button
          @click="closeVersionDetail"
          class="p-2 text-gray-400 hover:text-gray-600 rounded"
        >
          âœ•
        </button>
      </div>

      <!-- ç‰ˆæœ¬å†…å®¹ -->
      <div class="flex-1 p-4 overflow-auto">
        <div class="bg-gray-50 border rounded-lg p-4 h-full">
          <pre class="whitespace-pre-wrap text-sm text-gray-700 font-mono">{{ selectedVersionContent }}</pre>
        </div>
      </div>

      <!-- å¼¹çª—åº•éƒ¨æ“ä½œ -->
      <div class="p-4 border-t border-gray-200 flex justify-end gap-2">
        <button
          @click="closeVersionDetail"
          class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200"
        >
          å…³é—­
        </button>
        <button
          v-if="selectedCommit && commits[0]?.id !== selectedCommit.id"
          @click="confirmRevertToVersion(selectedCommit)"
          class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600"
        >
          å›æ»šåˆ°æ­¤ç‰ˆæœ¬
        </button>

const diffChanges = ref<any[]>([])
const diffStats = computed(() => {
  if (!diffChanges.value.length) return { added: 0, removed: 0, unchanged: 0 }
  return new DiffEngine().getDiffStats(diffChanges.value)
})

function clearDiff() {
  diffChanges.value = []
}

        >
          å›æ»šåˆ°æ­¤ç‰ˆæœ¬
        </button>
      </div>
    </div>

const diffChanges = ref<any[]>([])
const diffStats = computed(() => {
  if (!diffChanges.value.length) return { added: 0, removed: 0, unchanged: 0 }
  return new DiffEngine().getDiffStats(diffChanges.value)
})

function clearDiff() {
  diffChanges.value = []
}

  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { storeToRefs } from 'pinia'
import { useAppStore } from '../../stores/app'
import { DiffEngine } from '../../models/DiffEngine'
import type { CommitInfo } from '../../types/index'

interface Emits {
  (e: 'close'): void
  (e: 'revert', commitId: string, content: string): void
}

const emit = defineEmits<Emits>()

const app = useAppStore()
const { commits, currentDocument, commitData } = storeToRefs(app)
const selectedIds = ref<string[]>([])
const diffText = ref('')

// ç‰ˆæœ¬è¯¦æƒ…å¼¹çª—çŠ¶æ€
const showVersionDetail = ref(false)
const selectedCommit = ref<CommitInfo | null>(null)
const selectedVersionContent = ref('')

const engine = new DiffEngine()

// è®¡ç®—å±æ€§
const hasUnsavedChanges = computed(() => {
  if (commits.value.length === 0) return currentDocument.value.length > 0
  const latestCommit = commits.value[0]
  const latestContent = commitData.value[latestCommit.id] || ''
  return currentDocument.value !== latestContent
})

// æ ¼å¼åŒ–æ—¶é—´
const formatTimeAgo = (timestamp: number) => {
  const now = Date.now()
  const diff = now - timestamp
  const minutes = Math.floor(diff / (1000 * 60))
  const hours = Math.floor(diff / (1000 * 60 * 60))
  const days = Math.floor(diff / (1000 * 60 * 60 * 24))

  if (minutes < 1) return 'åˆšæ‰'
  if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`
  if (hours < 24) return `${hours}å°æ—¶å‰`
  return `${days}å¤©å‰`
}

const formatDateTime = (timestamp: number) => {
  return new Date(timestamp).toLocaleString('zh-CN')
}

// è·å–ç‰ˆæœ¬å­—æ•°
const getVersionWordCount = (commitId: string) => {
  const content = commitData.value[commitId] || ''
  return content.trim().split(/\s+/).filter(word => word.length > 0).length
}

function createCommit() {
  const message = prompt('è¯·è¾“å…¥ç‰ˆæœ¬æè¿°ï¼š')
  if (message && message.trim()) {
    app.createCommit(message.trim())
  } else {
    app.createCommit('æ‰‹åŠ¨æäº¤')
  }
}

function getSnapshot(commitId: string): string {
  const d = app.getCommitDiff(commitId)
  return d?.content || ''
}

function diffSelected() {
  if (selectedIds.value.length !== 2) return
  const [a, b] = selectedIds.value
  const oldText = getSnapshot(a)
  const newText = getSnapshot(b)
  const result = engine.diff(oldText, newText)
  diffChanges.value = result.changes
}

// æŸ¥çœ‹ç‰ˆæœ¬è¯¦æƒ…
const handleViewVersion = (commit: CommitInfo) => {
  selectedCommit.value = commit
  selectedVersionContent.value = commitData.value[commit.id] || 'å†…å®¹ä¸å¯ç”¨'
  showVersionDetail.value = true
}

// å…³é—­ç‰ˆæœ¬è¯¦æƒ…
const closeVersionDetail = () => {
  showVersionDetail.value = false
  selectedCommit.value = null
  selectedVersionContent.value = ''
}

// å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
const handleRevertToVersion = (commit: CommitInfo) => {
  if (window.confirm(`ç¡®å®šè¦å›æ»šåˆ°ç‰ˆæœ¬"${commit.message}"å—ï¼Ÿå½“å‰æœªä¿å­˜çš„æ›´æ”¹å°†ä¼šä¸¢å¤±ã€‚`)) {
    const content = commitData.value[commit.id] || ''
    emit('revert', commit.id, content)
  }
}

// ä»å¼¹çª—ç¡®è®¤å›æ»š
const confirmRevertToVersion = (commit: CommitInfo) => {
  closeVersionDetail()
  handleRevertToVersion(commit)
}

// è‡ªåŠ¨ä¿å­˜å½“å‰ç‰ˆæœ¬
const handleAutoSave = () => {
  if (hasUnsavedChanges.value) {
    app.createCommit('è‡ªåŠ¨ä¿å­˜')
  }
}

// æ¸…é™¤é€‰æ‹©
const clearSelected = () => {
  selectedIds.value = []
  diffText.value = ''
}
</script>

