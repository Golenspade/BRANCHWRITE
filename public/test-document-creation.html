<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•æ–‡æ¡£åˆ›å»ºåŠŸèƒ½</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #da190b;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .log {
      margin-top: 10px;
      padding: 10px;
      background: #e8f5e9;
      border-left: 4px solid #4CAF50;
      border-radius: 4px;
    }
    .error {
      background: #ffebee;
      border-left-color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª æ–‡æ¡£åˆ›å»ºåŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="section">
      <h2>1. åˆ›å»ºæµ‹è¯•ä¹¦ç±</h2>
      <button onclick="createTestBook()">åˆ›å»ºæµ‹è¯•ä¹¦ç±</button>
      <button onclick="listBooks()">æŸ¥çœ‹æ‰€æœ‰ä¹¦ç±</button>
      <div id="bookResult"></div>
    </div>

    <div class="section">
      <h2>2. åˆ›å»ºæµ‹è¯•æ–‡æ¡£</h2>
      <input type="text" id="docTitle" placeholder="æ–‡æ¡£æ ‡é¢˜" value="æµ‹è¯•æ–‡æ¡£">
      <select id="docType">
        <option value="ç« èŠ‚">ç« èŠ‚</option>
        <option value="ç¬”è®°">ç¬”è®°</option>
        <option value="å¤§çº²">å¤§çº²</option>
      </select>
      <button onclick="createTestDocument()">åˆ›å»ºæ–‡æ¡£</button>
      <button onclick="listDocuments()">æŸ¥çœ‹æ–‡æ¡£åˆ—è¡¨</button>
      <div id="docResult"></div>
    </div>

    <div class="section">
      <h2>3. æŸ¥çœ‹ LocalStorage</h2>
      <button onclick="showLocalStorage()">æ˜¾ç¤ºæ‰€æœ‰æ•°æ®</button>
      <button class="danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
      <div id="storageResult"></div>
    </div>

    <div class="section">
      <h2>4. æµ‹è¯•æ—¥å¿—</h2>
      <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
      <div id="logs"></div>
    </div>
  </div>

  <script>
    let currentBookId = null;

    function log(message, isError = false) {
      const logsDiv = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = isError ? 'log error' : 'log';
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.insertBefore(logEntry, logsDiv.firstChild);
      console.log(message);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    function createTestBook() {
      try {
        const projects = JSON.parse(localStorage.getItem('branchwrite_projects') || '[]');
        
        const newBook = {
          id: `project_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          name: 'æµ‹è¯•ä¹¦ç± ' + new Date().toLocaleTimeString(),
          description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä¹¦ç±',
          author: 'æµ‹è¯•ä½œè€…',
          created_at: new Date().toISOString(),
          last_modified: new Date().toISOString(),
          version: '1.0.0',
          settings: {
            auto_save_interval: 30,
            auto_commit_threshold: 100,
            backup_enabled: true,
            backup_interval: 300,
            editor_theme: 'default',
            font_size: 14,
            line_height: 1.5,
            font_family: 'system-ui',
          },
        };

        projects.unshift(newBook);
        localStorage.setItem('branchwrite_projects', JSON.stringify(projects));
        
        currentBookId = newBook.id;
        log(`âœ… ä¹¦ç±åˆ›å»ºæˆåŠŸ: ${newBook.name} (ID: ${newBook.id})`);
        
        document.getElementById('bookResult').innerHTML = `
          <pre>${JSON.stringify(newBook, null, 2)}</pre>
        `;
      } catch (error) {
        log(`âŒ åˆ›å»ºä¹¦ç±å¤±è´¥: ${error.message}`, true);
      }
    }

    function listBooks() {
      try {
        const projects = JSON.parse(localStorage.getItem('branchwrite_projects') || '[]');
        log(`ğŸ“š æ‰¾åˆ° ${projects.length} æœ¬ä¹¦ç±`);
        
        document.getElementById('bookResult').innerHTML = `
          <pre>${JSON.stringify(projects, null, 2)}</pre>
        `;
      } catch (error) {
        log(`âŒ è·å–ä¹¦ç±åˆ—è¡¨å¤±è´¥: ${error.message}`, true);
      }
    }

    function createTestDocument() {
      if (!currentBookId) {
        log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¹¦ç±', true);
        alert('è¯·å…ˆç‚¹å‡»"åˆ›å»ºæµ‹è¯•ä¹¦ç±"æŒ‰é’®');
        return;
      }

      try {
        const title = document.getElementById('docTitle').value;
        const type = document.getElementById('docType').value;
        
        const documentKey = `branchwrite_documents_${currentBookId}`;
        const documents = JSON.parse(localStorage.getItem(documentKey) || '[]');
        
        const newDocument = {
          id: `doc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          book_id: currentBookId,
          title,
          order: documents.length + 1,
          type,
          created_at: new Date().toISOString(),
          last_modified: new Date().toISOString(),
          word_count: 0,
          character_count: 0,
          status: 'draft',
        };

        documents.unshift(newDocument);
        localStorage.setItem(documentKey, JSON.stringify(documents));
        
        log(`âœ… æ–‡æ¡£åˆ›å»ºæˆåŠŸ: ${newDocument.title} (ID: ${newDocument.id})`);
        
        document.getElementById('docResult').innerHTML = `
          <pre>${JSON.stringify(newDocument, null, 2)}</pre>
        `;
      } catch (error) {
        log(`âŒ åˆ›å»ºæ–‡æ¡£å¤±è´¥: ${error.message}`, true);
      }
    }

    function listDocuments() {
      if (!currentBookId) {
        log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¹¦ç±', true);
        return;
      }

      try {
        const documentKey = `branchwrite_documents_${currentBookId}`;
        const documents = JSON.parse(localStorage.getItem(documentKey) || '[]');
        log(`ğŸ“„ æ‰¾åˆ° ${documents.length} ä¸ªæ–‡æ¡£`);
        
        document.getElementById('docResult').innerHTML = `
          <pre>${JSON.stringify(documents, null, 2)}</pre>
        `;
      } catch (error) {
        log(`âŒ è·å–æ–‡æ¡£åˆ—è¡¨å¤±è´¥: ${error.message}`, true);
      }
    }

    function showLocalStorage() {
      try {
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('branchwrite_')) {
            try {
              allData[key] = JSON.parse(localStorage.getItem(key));
            } catch {
              allData[key] = localStorage.getItem(key);
            }
          }
        }
        
        log(`ğŸ’¾ LocalStorage ä¸­æœ‰ ${Object.keys(allData).length} ä¸ªç›¸å…³é”®`);
        
        document.getElementById('storageResult').innerHTML = `
          <pre>${JSON.stringify(allData, null, 2)}</pre>
        `;
      } catch (error) {
        log(`âŒ è¯»å– LocalStorage å¤±è´¥: ${error.message}`, true);
      }
    }

    function clearAllData() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ä¹¦ç±å’Œæ–‡æ¡£ï¼')) {
        return;
      }

      try {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('branchwrite_')) {
            keysToRemove.push(key);
          }
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        currentBookId = null;
        
        log(`ğŸ—‘ï¸  å·²æ¸…ç©º ${keysToRemove.length} ä¸ªæ•°æ®é¡¹`);
        document.getElementById('storageResult').innerHTML = '';
        document.getElementById('bookResult').innerHTML = '';
        document.getElementById('docResult').innerHTML = '';
      } catch (error) {
        log(`âŒ æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, true);
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰çŠ¶æ€
    window.onload = function() {
      log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½');
      showLocalStorage();
    };
  </script>
</body>
</html>
