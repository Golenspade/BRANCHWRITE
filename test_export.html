<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导出功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>BranchWrite 导出功能测试</h1>
    
    <div>
        <button onclick="testCreateProject()">1. 创建测试项目</button>
        <button onclick="testExportProject()">2. 测试导出功能</button>
        <button onclick="testGetDesktopDir()">3. 测试获取桌面目录</button>
        <button onclick="clearLog()">清除日志</button>
    </div>
    
    <div id="log" class="log">点击按钮开始测试...</div>

    <script>
        let testProjectId = null;
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
        }
        
        async function testCreateProject() {
            try {
                log('开始创建测试项目...');
                
                // 检查是否在 Tauri 环境中
                if (typeof window.__TAURI__ === 'undefined') {
                    log('错误: 不在 Tauri 环境中，请在应用程序中运行此测试');
                    return;
                }
                
                const { invoke } = window.__TAURI__.core;
                
                const projectData = await invoke('create_project', {
                    name: '导出测试项目',
                    description: '这是一个用于测试导出功能的项目',
                    author: '测试用户'
                });
                
                testProjectId = projectData.config.id;
                log(`项目创建成功! ID: ${testProjectId}`);
                log(`项目名称: ${projectData.config.name}`);
                
                // 添加一些内容
                projectData.document_content = `# 导出测试项目

这是一个测试项目，用于验证导出功能是否正常工作。

## 内容

这里是一些测试内容：

- 列表项 1
- 列表项 2
- 列表项 3

## 代码示例

\`\`\`javascript
function hello() {
    console.log("Hello, World!");
}
\`\`\`

## 结论

如果你能看到这个文件，说明导出功能正常工作！
`;
                
                await invoke('save_project', { projectData });
                log('项目内容已保存');
                
            } catch (error) {
                log(`创建项目失败: ${error}`);
            }
        }
        
        async function testGetDesktopDir() {
            try {
                log('测试获取桌面目录...');
                
                if (typeof window.__TAURI__ === 'undefined') {
                    log('错误: 不在 Tauri 环境中');
                    return;
                }
                
                const { invoke } = window.__TAURI__.core;
                const desktopDir = await invoke('get_desktop_dir');
                log(`桌面目录: ${desktopDir}`);
                
            } catch (error) {
                log(`获取桌面目录失败: ${error}`);
            }
        }
        
        async function testExportProject() {
            try {
                if (!testProjectId) {
                    log('错误: 请先创建测试项目');
                    return;
                }
                
                log('开始测试导出功能...');
                
                if (typeof window.__TAURI__ === 'undefined') {
                    log('错误: 不在 Tauri 环境中');
                    return;
                }
                
                const { invoke } = window.__TAURI__.core;
                
                // 获取桌面目录
                const desktopDir = await invoke('get_desktop_dir');
                log(`桌面目录: ${desktopDir}`);
                
                // 创建导出路径
                const exportPath = `${desktopDir}/BranchWrite_导出测试项目_${new Date().toISOString().split('T')[0]}`;
                log(`导出路径: ${exportPath}`);
                
                // 执行导出
                await invoke('export_project', {
                    projectId: testProjectId,
                    exportPath: exportPath
                });
                
                log('导出成功！');
                log(`请检查桌面上的文件夹: BranchWrite_导出测试项目_${new Date().toISOString().split('T')[0]}`);
                
            } catch (error) {
                log(`导出失败: ${error}`);
            }
        }
        
        // 页面加载时检查环境
        window.addEventListener('load', () => {
            if (typeof window.__TAURI__ === 'undefined') {
                log('警告: 当前不在 Tauri 环境中。请将此文件复制到应用程序中运行测试。');
            } else {
                log('Tauri 环境检测成功，可以开始测试。');
            }
        });
    </script>
</body>
</html>
